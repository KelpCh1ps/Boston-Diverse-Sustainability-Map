<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Boston DSM</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DynaPuff:wght@400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="map.css">
</head>

<script type="module" src="./mapdata.js"></script>

<body>

<div id="appShell" style="display:flex; height:100vh;">
    <!-- Sidebar -->
    <aside id="sidebarPane" class="sidebar-pane" style="width:370px; min-width:300px; max-width:420px; background:#fff; border-right:1px solid #e0e0e0; display:flex; flex-direction:column;">
        <button id="sidebarToggle" class="sidebar-toggle" type="button" onclick="toggleSidebar()" aria-label="Collapse sidebar" aria-expanded="true">
            â—€
        </button>
        <div class="sidebar-content" style="padding:2rem 1.5rem 1rem 1.5rem; border-bottom:1px solid #eee;">
            <div style="display:flex; align-items:center; gap:0rem; margin-bottom:1.5rem;">
                <img src="./icons/BDSM_Logo.png" alt="Boston DSM Logo" class="boston-dsm-logo" style="height:80px; margin-bottom:0;">
                <span style="font-size:2rem; font-weight:700; color:#222; font-family:'DynaPuff',system-ui;">Boston DSM</span>
            </div>
            <input class="search-input" id="searchBar" type="text" placeholder="Search places or paste a link" list="searchSuggestions" autocomplete="off">
            <datalist id="searchSuggestions"></datalist>
        </div>
        <div class="sidebar-content" style="flex:1;overflow-y:auto;padding:1.5rem;">
            <div id="placeDetailsPanel" class="place-details-panel"></div>
        </div>
    </aside>

    <!-- Main Map Area -->
    <main style="flex:1;display:flex;flex-direction:column;position:relative;background:#f5f5f5;">
        <!-- Horizontal Category Bar -->
        <div style="display:flex;gap:1rem;position:absolute;top:2rem;left:50%;transform:translateX(-50%);z-index:10;background:rgba(255,255,255,0.95);border-radius:2rem;box-shadow:0 2px 8px rgba(0,0,0,0.07);padding:0.5rem 1.5rem;">
            
            <button onclick="filterCategory('food')" style="background:none;border:none;display:flex;align-items:center;gap:0.5rem;font-size:1rem;cursor:pointer;padding:0.5rem 1rem;border-radius:2rem;transition:background 0.2s;font-family:'DynaPuff',system-ui;font-optical-sizing:auto;font-weight:400;font-style:normal;font-variation-settings:'wdth' 100;">
                Food
            </button>
            <button onclick="filterCategory('retail')" style="background:none;border:none;display:flex;align-items:center;gap:0.5rem;font-size:1rem;cursor:pointer;padding:0.5rem 1rem;border-radius:2rem;transition:background 0.2s;font-family:'DynaPuff',system-ui;font-optical-sizing:auto;font-weight:400;font-style:normal;font-variation-settings:'wdth' 100;">
                Grocery
            </button>
            <button onclick="filterCategory('wholesale')" style="background:none;border:none;display:flex;align-items:center;gap:0.5rem;font-size:1rem;cursor:pointer;padding:0.5rem 1rem;border-radius:2rem;transition:background 0.2s;font-family:'DynaPuff',system-ui;font-optical-sizing:auto;font-weight:400;font-style:normal;font-variation-settings:'wdth' 100;">
                Wholesale
            </button>
            <button onclick="filterCategory('farm')" style="background:none;border:none;display:flex;align-items:center;gap:0.5rem;font-size:1rem;cursor:pointer;padding:0.5rem 1rem;border-radius:2rem;transition:background 0.2s;font-family:'DynaPuff',system-ui;font-optical-sizing:auto;font-weight:400;font-style:normal;font-variation-settings:'wdth' 100;">
                Farms
            </button>
        </div>
        <div class="map-container" style="flex:1;width:100%;height:100%;">
            <div id="map" style="height:100%;width:100%;"></div>
        </div>
        <div style="position:absolute;bottom:2rem;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.95);border-radius:2rem;box-shadow:0 2px 8px rgba(0,0,0,0.07);padding:0.5rem 2rem;display:flex;gap:1.5rem;align-items:center;z-index:10;">
            <span>Sort by Price:</span>
            <button onclick="sortPlaces('price','asc')">Low â†’ High</button>
            <button onclick="sortPlaces('price','desc')">High â†’ Low</button>
            <span>Sort by Rating:</span>
            <button onclick="sortPlaces('rating','desc')">High â†’ Low</button>
            <button onclick="sortPlaces('rating','asc')">Low â†’ High</button>
        </div>
    </main>
</div>

<script>
(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
    key: "AIzaSyAurJ0-EQCqpMkspkluFiOviU8vDXuQlOk",
});

let map;
let placesService;
let allPlaces = [];
let filteredPlaces = [];
let markers = [];
let isSidebarCollapsed = false;
let activeCategory = "food";
let activeSearchQuery = "";

function toggleSidebar() {
    isSidebarCollapsed = !isSidebarCollapsed;
    document.body.classList.toggle("sidebar-collapsed", isSidebarCollapsed);

    const toggleButton = document.getElementById("sidebarToggle");
    toggleButton.textContent = isSidebarCollapsed ? "â–¶" : "â—€";
    toggleButton.setAttribute("aria-expanded", String(!isSidebarCollapsed));
    toggleButton.setAttribute("aria-label", isSidebarCollapsed ? "Expand sidebar" : "Collapse sidebar");

    if (map) {
        const currentCenter = map.getCenter();
        setTimeout(() => {
            google.maps.event.trigger(map, "resize");
            if (currentCenter) {
                map.setCenter(currentCenter);
            }
        }, 280);
    }
}

function setupSearchBar() {
    const searchInput = document.getElementById("searchBar");
    if (!searchInput) return;

    searchInput.addEventListener("input", (event) => {
        activeSearchQuery = event.target.value.trim().toLowerCase();
        applyFiltersAndRender();
    });
}

function updateSearchSuggestions() {
    const suggestions = document.getElementById("searchSuggestions");
    if (!suggestions) return;

    const source = applyCategoryFilter(allPlaces);
    const names = [...new Set(
        source
            .map(place => (place.name || "").trim())
            .filter(Boolean)
    )];

    let rankedNames = names;
    if (activeSearchQuery) {
        const startsWithQuery = names.filter(name =>
            name.toLowerCase().startsWith(activeSearchQuery)
        );
        const includesQuery = names.filter(name => {
            const lowered = name.toLowerCase();
            return !lowered.startsWith(activeSearchQuery) && lowered.includes(activeSearchQuery);
        });
        rankedNames = [...startsWithQuery, ...includesQuery];
    }

    suggestions.innerHTML = "";
    rankedNames.slice(0, 10).forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        suggestions.appendChild(option);
    });
}

async function initMap() {
    const { Map } = await google.maps.importLibrary("maps");
    const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
    await google.maps.importLibrary("places");

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {

            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            map = new Map(document.getElementById("map"), {
                zoom: 13,
                center: userLocation,
                mapId: "1907e1268c94d0034153c21a",
                mapTypeId: "terrain",
                mapTypeControl: false,
                draggableCursor: "crosshair",
                draggingCursor: "grabbing",
                styles: [
                    { elementType: "labels", stylers: [{ visibility: "off" }] }
                ]
            });

            new AdvancedMarkerElement({
                map: map,
                position: userLocation,
                title: "You are here"
            });

            placesService = new google.maps.places.PlacesService(map);
            fetchFoodPlaces(userLocation);

        }, () => {
            alert("Location permission denied.");
        });
    }
}

function fetchFoodPlaces(location) {

    const types = [
        "restaurant",
        "cafe",
        "bakery",
        "meal_takeaway",
        "meal_delivery",
        "supermarket",
        "grocery_or_supermarket",
        "convenience_store",
        "liquor_store"
    ];

    const keywords = [
        "farm",
        "food factory",
        "food distributor",
        "wholesale food"
    ];

    allPlaces = [];

    types.forEach(type => {
        placesService.nearbySearch({
            location,
            radius: 3000,
            type
        }, handleResults);
    });

    keywords.forEach(keyword => {
        placesService.nearbySearch({
            location,
            radius: 3000,
            keyword
        }, handleResults);
    });
}

function handleResults(results, status) {
    if (status === google.maps.places.PlacesServiceStatus.OK) {

        results.forEach(place => {
            if (!allPlaces.some(p => p.place_id === place.place_id)) {
                allPlaces.push(place);
            }
        });

        applyFiltersAndRender();
    }
}

function isFoodPlace(place) {
    const types = place.types || [];
    return types.includes("restaurant") ||
        types.includes("cafe") ||
        types.includes("bakery") ||
        types.includes("meal_takeaway") ||
        types.includes("meal_delivery") ||
        types.includes("bar") ||
        types.includes("night_club") ||
        types.includes("pub");
}

// ðŸ”¹ Filter by category
function filterCategory(category) {
    activeCategory = category;
    applyFiltersAndRender();
}

function applyCategoryFilter(data) {
    if (activeCategory === "all") {
        return [...data];
    }

    if (activeCategory === "food") {
        return data.filter(isFoodPlace);
    }

    if (activeCategory === "retail") {
        return data.filter(p =>
            (p.types || []).includes("supermarket") ||
            (p.types || []).includes("grocery_or_supermarket") ||
            (p.types || []).includes("convenience_store") ||
            (p.types || []).includes("liquor_store")
        );
    }

    if (activeCategory === "wholesale") {
        return data.filter(p =>
            (p.name || "").toLowerCase().includes("distributor") ||
            (p.name || "").toLowerCase().includes("wholesale") ||
            (p.name || "").toLowerCase().includes("factory")
        );
    }

    if (activeCategory === "farm") {
        return data.filter(p => (p.name || "").toLowerCase().includes("farm"));
    }

    return [...data];
}

function applySearchFilter(data) {
    if (!activeSearchQuery) {
        return data;
    }

    return data.filter(place => (place.name || "").toLowerCase().includes(activeSearchQuery));
}

function applyFiltersAndRender() {
    const categoryFiltered = applyCategoryFilter(allPlaces);
    filteredPlaces = applySearchFilter(categoryFiltered);
    updateSearchSuggestions();
    renderAll();
}

// ðŸ”¹ General render
function renderAll() {
    renderMarkers(filteredPlaces);
}

function createFoodPinContent(place) {
    const pin = document.createElement("button");
    pin.type = "button";
    pin.className = "food-pin";
    pin.setAttribute("aria-label", place.name);

    const bubble = document.createElement("span");
    bubble.className = "food-pin__bubble";

    const image = document.createElement("img");
    image.className = "food-pin__image";
    image.src = getPinImageForPlace(place);
    image.alt = "";
    image.setAttribute("aria-hidden", "true");

    const pulse = document.createElement("span");
    pulse.className = "food-pin__pulse";
    pulse.setAttribute("aria-hidden", "true");

    bubble.appendChild(image);
    pin.appendChild(bubble);
    pin.appendChild(pulse);
    return pin;
}

function getPinImageForPlace(place) {
    const types = place.types || [];
    const loweredName = (place.name || "").toLowerCase();

    if (loweredName.includes("farm")) {
        return "icons/Food_Pantry_Logo.png";
    }

    if (
        types.includes("supermarket") ||
        types.includes("grocery_or_supermarket") ||
        types.includes("convenience_store")
    ) {
        return "icons/Market_Logo.png";
    }

    return "icons/restaurant_logo.png";
}

// ðŸ”¹ Render map markers
function renderMarkers(data) {
    const { AdvancedMarkerElement } = google.maps.marker;

    markers.forEach(marker => marker.map = null);
    markers = [];
    clearSidebarDetails();

    data.forEach(place => {
        const pinContent = createFoodPinContent(place);

        const marker = new AdvancedMarkerElement({
            map: map,
            position: place.geometry.location,
            title: place.name,
            gmpClickable: true,
            content: pinContent
        });

        const showDetails = () => showSidebarDetails(place);
        const hideDetails = () => clearSidebarDetails();

        pinContent.addEventListener("mouseenter", showDetails);
        pinContent.addEventListener("mouseleave", hideDetails);
        pinContent.addEventListener("focus", showDetails);
        pinContent.addEventListener("blur", hideDetails);

        markers.push(marker);
    });
}

function getPlacePhotoUrl(place) {
    if (place.photos && place.photos.length > 0) {
        return place.photos[0].getUrl({ maxWidth: 640, maxHeight: 380 });
    }
    return "";
}

function clearSidebarDetails() {
    const panel = document.getElementById("placeDetailsPanel");
    if (!panel) return;
    panel.innerHTML = "";
}

function showSidebarDetails(place) {
    const panel = document.getElementById("placeDetailsPanel");
    if (!panel) return;

    const priceLevel = place.price_level;
    const priceDisplay = typeof priceLevel === "number" ? "$".repeat(priceLevel) : "N/A";
    const rating = place.rating ?? "N/A";
    const address = place.vicinity ?? "Address unavailable";
    const photoUrl = getPlacePhotoUrl(place);

    panel.innerHTML = `
        ${photoUrl ? `<img class="place-details-photo" src="${photoUrl}" alt="${place.name}">` : ""}
        <h3 class="place-details-title">${place.name}</h3>
        <div class="place-details-meta"><strong>Price:</strong> ${priceDisplay}</div>
        <div class="place-details-meta"><strong>Rating:</strong> ${rating}</div>
        <div class="place-details-meta"><strong>Address:</strong> ${address}</div>
    `;
}


// ðŸ”¹ General sorting: type = 'price' or 'rating'
function sortPlaces(type, order) {
    filteredPlaces.sort((a, b) => {
        let valA, valB;

        if (type === "price") {
            valA = a.price_level ?? 0;
            valB = b.price_level ?? 0;
        } else if (type === "rating") {
            valA = a.rating ?? 0;
            valB = b.rating ?? 0;
        }

        return order === "asc" ? valA - valB : valB - valA;
    });

    renderAll();
}

initMap();
setupSearchBar();
</script>

</body>
</html>
